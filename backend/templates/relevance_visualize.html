{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block content %}
<div class="relevance-visualize-page">
    <h1>{{ title }}</h1>
    <p class="text-color-light mb-4">
        Visual representation of relevance links between Process Steps.
        Node size indicates the number of associated use cases.
        Link width and value show the relevance score (0-100).
    </p>

    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title">Relevance Map</h2>
        </div>
        <div class="card-body">
            <div id="relevanceChart" style="width: 100%; height: 600px;"></div>
        </div>
    </div>

    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Back to Overview</a>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Include any scripts from base.html first #}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var chartDom = document.getElementById('relevanceChart');
        if (!chartDom) {
            console.error("Chart container #relevanceChart not found.");
            return;
        }

        var myChart = echarts.init(chartDom);
        // prettier-ignore
        // @ts-ignore
        var echartsData = {{ echarts_data | tojson }}; // Data passed from Flask

        var option;

        option = {
            tooltip: {
                trigger: 'item',
                formatter: function (params) {
                    if (params.dataType === 'node') {
                        return params.data.tooltip.formatter; // Use custom node tooltip
                    } else if (params.dataType === 'edge') {
                        var sourceName = echartsData.nodes.find(n => n.id === params.data.source)?.name || params.data.source;
                        var targetName = echartsData.nodes.find(n => n.id === params.data.target)?.name || params.data.target;
                        // Using a plain right arrow character to avoid potential encoding issues with HTML entities
                        return `<strong>${sourceName}</strong> â†’ <strong>${targetName}</strong><br>` + params.data.tooltip.formatter; // Use custom link tooltip
                    }
                    return '';
                }
            },
            legend: {
                data: echartsData.categories.map(c => c.name),
                bottom: 0,
                orient: 'horizontal',
                type: 'scroll'
            },
            series: [
                {
                    name: 'Process Relevance',
                    type: 'graph',
                    layout: 'circular',
                    circular: {
                        rotateLabel: true
                    },
                    data: echartsData.nodes,
                    links: echartsData.links,
                    categories: echartsData.categories,
                    roam: true, // Enable dragging and zooming
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{b}', // Display node name
                        fontSize: 10
                    },
                    labelLayout: {
                        hideOverlap: true
                    },
                    lineStyle: {
                        opacity: 0.8,
                        width: 2, // Default width, overridden by link.lineStyle.width
                        curveness: 0.3 // Default curveness, overridden by link.lineStyle.curveness
                    },
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: {
                            width: 5 // Thicker line on hover
                        }
                    },
                    force: {
                        // Adjust force layout parameters if needed for better circular distribution
                        // repulsion: 500, // Node repulsion force
                        // edgeLength: 100 // Edge length
                    }
                }
            ]
        };

        myChart.setOption(option);

        // Optional: Resize chart with window
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    });
</script>
{% endblock %}
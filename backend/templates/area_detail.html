{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block head_extra %}
    {{ super() }}
    <!-- Marked.js for rendering markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}


{% block content %}
<div class="area-detail-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Area: {{ area.name }}</h1>
        <div class="actions-button-group">
            <form action="{{ url_for('areas.delete_area', area_id=area.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this area and all its process steps and use cases? This action cannot be undone.');">
                <button type="submit" class="btn btn-sm btn-danger">Delete Area</button>
            </form>
            <a href="{{ url_for('export.export_area_md', area_id=area.id) }}" class="btn btn-sm btn-info">Export to Markdown</a>
        </div>
    </div>
    <p class="text-color-light mb-3">View and edit details for Area ID: {{ area.id }}.</p>

    <form method="POST">
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">Area Information</h2>
            </div>
            <div class="card-body">
                <dl class="info-list">
                    <dt>Name:</dt>
                    <dd>
                        <input type="text" class="form-control" id="name" name="name"
                               value="{{ area.name }}" required>
                    </dd>

                    <dt>Created At:</dt>
                    <dd class="pt-2">{{ area.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if area.created_at else 'N/A' }}</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">Description</h2>
                <button type="button" class="btn btn-sm btn-secondary" id="toggleDescriptionEditBtn">
                    <i class="fas fa-edit"></i> Edit Description
                </button>
            </div>
            <div class="card-body">
                <!-- Markdown Display Area -->
                <div id="descriptionDisplay" class="markdown-content">
                    {{ area.description | markdown | default('<em>No description provided. Click "Edit" to add one.</em>' | safe, true) }}
                </div>
                <!-- Hidden Textarea for Editing -->
                <textarea class="form-control" id="description" name="description" rows="8" style="display: none;" 
                          placeholder="Enter area description here. Markdown is supported.">{{ area.description | default('', true) }}</textarea>
            </div>
        </div>
        
        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{{ url_for('areas.list_areas') }}" class="btn btn-secondary">Back to Area List</a>
        </div>
    </form>


    <div class="card mt-4">
        <div class="card-header">
            <h2 class="card-title">Process Steps in this Area</h2>
        </div>
        <div class="card-body">
            {% if area.process_steps %}
                <ul class="list-unstyled item-list">
                    {% for step in area.process_steps | sort(attribute='name') %}
                        <li class="mb-2">
                            <div class="item-title">
                                <a href="{{ url_for('steps.view_step', step_id=step.id) }}">{{ step.name }}</a>
                            </div>
                            <div class="item-meta">
                                <small class="text-muted">(BI_ID: {{ step.bi_id }})</small>
                            </div>
                            {% if step.use_cases %}
                                <ul class="usecase-list mt-1" style="padding-left: 20px; list-style: circle;">
                                    {% for uc in step.use_cases | sort(attribute='name') %}
                                    <li>
                                        <a href="{{ url_for('usecases.view_usecase', usecase_id=uc.id) }}">{{ uc.name }}</a>
                                        <small class="uc-details text-muted">(UC BI_ID: {{ uc.bi_id }})</small>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="mb-0" style="padding-left: 20px;"><em><small>No use cases directly under this step.</small></em></p>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mb-0"><em>No process steps found in this area.</em></p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggleDescriptionEditBtn');
    const displayDiv = document.getElementById('descriptionDisplay');
    const editTextarea = document.getElementById('description');
    
    let isEditing = false;

    if (toggleBtn && displayDiv && editTextarea) {
        toggleBtn.addEventListener('click', function() {
            isEditing = !isEditing;

            if (isEditing) {
                // Switch to edit mode
                displayDiv.style.display = 'none';
                editTextarea.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye"></i> View Markdown';
                this.classList.remove('btn-secondary');
                this.classList.add('btn-info');
            } else {
                // Switch to view mode
                // Re-render the markdown from the textarea content
                const newMarkdown = editTextarea.value;
                if (newMarkdown.trim()) {
                    displayDiv.innerHTML = marked.parse(newMarkdown);
                } else {
                    displayDiv.innerHTML = '<em>No description provided. Click "Edit" to add one.</em>';
                }
                
                displayDiv.style.display = 'block';
                editTextarea.style.display = 'none';
                this.innerHTML = '<i class="fas fa-edit"></i> Edit Description';
                this.classList.remove('btn-info');
                this.classList.add('btn-secondary');
            }
        });
    }
});
</script>
{% endblock %}
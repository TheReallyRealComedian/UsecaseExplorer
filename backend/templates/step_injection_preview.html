<!-- backend/templates/step_injection_preview.html -->
{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block content %}
<div class="step-injection-preview-page">
    <h1>{{ title }}</h1>
    <p class="text-color-light mb-4">
        Review the proposed changes for Process Steps. Choose which values to keep or edit them before finalizing the import.
    </p>

    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title">Step Changes Preview</h2>
        </div>
        <div class="card-body">
            {% if preview_data %}
            <form id="finalizeStepImportForm">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;">Status</th>
                                <th style="width: 10%;">BI_ID</th>
                                <th style="width: 15%;">Name</th>
                                <th style="width: 15%;">Area</th>
                                {% for field_key, field_name in step_fields.items() %} {# Loop over all fields #}
                                    {% if field_key != 'name' %} {# Only render if it's NOT the 'name' field #}
                                        <th style="width: calc(50% / {{ step_fields|length - 1 }});">{{ field_name }}</th>
                                    {% endif %}
                                {% endfor %}
                                <th style="width: 5%;">Action</th> {# New column for skip/add/update radio #}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in preview_data %}
                            <tr data-bi-id="{{ item.bi_id }}" data-status="{{ item.status }}" data-row-index="{{ loop.index0 }}">
                                <td class="text-center">
                                    <span class="badge 
                                        {% if item.status == 'new' %}bg-success
                                        {% elif item.status == 'update' %}bg-warning text-dark
                                        {% elif item.status == 'no_change' %}bg-secondary
                                        {% else %}bg-danger{% endif %}">
                                        {{ item.status | upper }}
                                    </span>
                                    {% if item.messages %}
                                        <div class="small text-muted mt-1">{{ item.messages[0] | default('') }}</div>
                                    {% endif %}
                                </td>
                                <td>{{ item.bi_id }}</td>
                                <td>
                                    {# Name field - always an editable input #}
                                    <label class="d-block mb-1 fw-bold">Final Name:</label>
                                    <input type="text" 
                                           class="form-control form-control-sm final-value-input" 
                                           data-field="name" 
                                           value="{{ item.new_values.name | default(item.json_data.name) | default('') }}"
                                           {% if item.status == 'skipped' or item.status == 'no_change' and not item.conflicts %}disabled{% endif %}>
                                </td>
                                <td>
                                    {# Area selection - always a dropdown #}
                                    <label class="d-block mb-1 fw-bold">Final Area:</label>
                                    <select class="form-select form-select-sm final-area-select" data-field="area_id"
                                        {% if item.status == 'skipped' or item.status == 'no_change' and not item.conflicts %}disabled{% endif %}>
                                        {% for area in all_areas %}
                                            <option value="{{ area.id }}" 
                                                {% if item.new_values.area_id == area.id %}selected{% endif %}
                                                {% if item.status == 'update' and item.db_data.area_id == area.id and 'area_id' not in item.conflicts %}selected{% endif %}
                                            >
                                                {{ area.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    {% if 'area_id' in item.conflicts %}
                                        <small class="text-danger d-block mt-1">Current: {{ item.conflicts.area_id.old_value | default('N/A') }}</small>
                                        <small class="text-success d-block">JSON: {{ item.conflicts.area_id.new_value | default('N/A') }}</small>
                                    {% elif item.status == 'new' and item.area_name %}
                                        <small class="text-muted d-block mt-1">(From JSON: {{ item.area_name }})</small>
                                    {% elif item.status != 'new' and item.db_data.area_name %}
                                        <small class="text-muted d-block mt-1">(Current: {{ item.db_data.area_name }})</small>
                                    {% endif %}
                                </td>
                                {# Dynamic fields #}
                                {% for field_key, field_name in step_fields.items() %} {# Loop over all fields #}
                                    {% if field_key != 'name' %} {# Only render if it's NOT the 'name' field #}
                                        <td class="preview-cell">
                                            {% if item.status == 'skipped' %}
                                                <div class="text-muted text-center">N/A</div>
                                            {% elif field_key in item.conflicts %}
                                                <label class="d-block mb-1 fw-bold">Select Value:</label>
                                                <div class="form-check">
                                                    <input class="form-check-input radio-choice" type="radio" 
                                                           name="choice_{{ item.bi_id }}_{{ field_key }}" 
                                                           id="db_choice_{{ item.bi_id }}_{{ field_key }}" value="db"
                                                           data-bi-id="{{ item.bi_id }}" data-field="{{ field_key }}">
                                                    <label class="form-check-label" for="db_choice_{{ item.bi_id }}_{{ field_key }}">
                                                        Current DB:<br><pre>{{ item.conflicts[field_key].old_value | default('N/A (Empty)', true) }}</pre>
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input radio-choice" type="radio" 
                                                           name="choice_{{ item.bi_id }}_{{ field_key }}" 
                                                           id="json_choice_{{ item.bi_id }}_{{ field_key }}" value="json"
                                                           data-bi-id="{{ item.bi_id }}" data-field="{{ field_key }}">
                                                    <label class="form-check-label" for="json_choice_{{ item.bi_id }}_{{ field_key }}">
                                                        JSON:<br><pre>{{ item.conflicts[field_key].new_value | default('N/A (Empty)', true) }}</pre>
                                                    </label>
                                                </div>
                                                <label for="manual_input_{{ item.bi_id }}_{{ field_key }}" class="d-block mt-2 mb-1 fw-bold">Manual Override:</label>
                                                <textarea class="form-control form-control-sm final-value-input" 
                                                          data-field="{{ field_key }}" 
                                                          id="manual_input_{{ item.bi_id }}_{{ field_key }}" 
                                                          rows="2"></textarea>
                                            {% else %} {# new or no_change #}
                                                <label class="d-block mb-1 fw-bold">Final Value:</label>
                                                <textarea class="form-control form-control-sm final-value-input" 
                                                          data-field="{{ field_key }}" 
                                                          id="final_input_{{ item.bi_id }}_{{ field_key }}" 
                                                          rows="2"
                                                          {% if item.status == 'no_change' %}disabled{% endif %}
                                                ></textarea>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                                <td class="action-choice">
                                    {% if item.status == 'skipped' %}
                                        <span class="text-danger fw-bold">Skipped</span>
                                    {% else %}
                                        <div class="form-check">
                                            <input class="form-check-input action-radio" type="radio" name="action_{{ item.bi_id }}" id="action_add_{{ item.bi_id }}" value="add" {% if item.status == 'new' %}checked{% endif %}>
                                            <label class="form-check-label" for="action_add_{{ item.bi_id }}">Add</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input action-radio" type="radio" name="action_{{ item.bi_id }}" id="action_update_{{ item.bi_id }}" value="update" {% if item.status == 'update' or item.status == 'no_change' %}checked{% endif %}>
                                            <label class="form-check-label" for="action_update_{{ item.bi_id }}">Update</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input action-radio" type="radio" name="action_{{ item.bi_id }}" id="action_skip_{{ item.bi_id }}" value="skip">
                                            <label class="form-check-label" for="action_skip_{{ item.bi_id }}">Skip</label>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary me-2" id="cancelImportBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="confirmImportBtn">Confirm Import</button>
                </div>
            </form>
            {% else %}
                <p class="text-muted text-center"><em>No data to preview. Please upload a Process Step JSON file from the <a href="{{ url_for('injection.handle_injection') }}">Data Injection</a> page.</em></p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const finalizeForm = document.getElementById('finalizeStepImportForm');
        const confirmBtn = document.getElementById('confirmImportBtn');
        const cancelBtn = document.getElementById('cancelImportBtn');
        const previewRows = document.querySelectorAll('#finalizeStepImportForm tbody tr');
        const previewData = JSON.parse('{{ preview_data | tojson | safe }}'); // Original preview data
        const stepFieldsConfig = JSON.parse('{{ step_fields | tojson | safe }}'); // Fields config


        // Helper function to get the current value for a given field from a row
        function getFieldValue(row, fieldKey) {
            if (fieldKey === 'area_id') {
                const select = row.querySelector(`.final-area-select[data-field="${fieldKey}"]`);
                return select ? parseInt(select.value) : null;
            } else {
                const input = row.querySelector(`.final-value-input[data-field="${fieldKey}"]`);
                if (input) {
                    return input.value.trim() === '' ? null : input.value.trim();
                }
            }
            return null;
        }

        // --- Initialize input values and radio selections ---
        previewRows.forEach((row, index) => {
            const biId = row.dataset.biId;
            const item = previewData[index]; // Get the original item data for this row
            const status = item.status;

            // Handle action radios: initial state
            const actionAdd = row.querySelector(`#action_add_${biId}`);
            const actionUpdate = row.querySelector(`#action_update_${biId}`);
            const actionSkip = row.querySelector(`#action_skip_${biId}`);
            
            if (status === 'new' && actionAdd) { actionAdd.checked = true; }
            if ((status === 'update' || status === 'no_change') && actionUpdate) { actionUpdate.checked = true; }
            if (status === 'skipped' && actionSkip) { actionSkip.checked = true; } // Should already be disabled
            
            // Disable action radios if status is 'skipped' or 'new'/'update' initially
            if (status === 'skipped' && actionAdd && actionUpdate) {
                actionAdd.disabled = true;
                actionUpdate.disabled = true;
            } else if (status === 'new' && actionUpdate) {
                actionUpdate.disabled = true;
            } else if ((status === 'update' || status === 'no_change') && actionAdd) {
                actionAdd.disabled = true;
            }


            // Set initial values for name and area_id (from new_values)
            const nameInput = row.querySelector('input.final-value-input[data-field="name"]');
            const areaSelect = row.querySelector('select.final-area-select[data-field="area_id"]');

            if (nameInput) {
                nameInput.value = item.new_values.name || '';
                // Disable if no_change and no conflicts, or if skipped
                if (status === 'no_change' && !item.conflicts.name || status === 'skipped') {
                    nameInput.disabled = true;
                }
            }
            if (areaSelect) {
                // Pre-select based on item.new_values.area_id
                if (item.new_values.area_id !== undefined && item.new_values.area_id !== null) {
                    areaSelect.value = item.new_values.area_id;
                } else if (item.status === 'new' && item.area_name) {
                    // Fallback for new items, try to select by area_name
                    const matchingOption = Array.from(areaSelect.options).find(opt => opt.text.trim() === item.area_name);
                    if (matchingOption) {
                        areaSelect.value = matchingOption.value;
                    }
                }
                 // Disable if no_change and no conflicts, or if skipped
                if (status === 'no_change' && !item.conflicts.area_id || status === 'skipped') {
                    areaSelect.disabled = true;
                }
            }
            

            // Set initial values for other fields based on conflicts or status
            for (const fieldKey in stepFieldsConfig) {
                if (fieldKey === 'name') continue; // Already handled

                const manualInput = row.querySelector(`textarea.final-value-input[data-field="${fieldKey}"]`);
                if (!manualInput) continue; // Skip if element not found (e.g., if field was not displayed)

                if (status === 'skipped') {
                    manualInput.disabled = true;
                }
                
                if (fieldKey in item.conflicts) {
                    const radioDb = row.querySelector(`#db_choice_${biId}_${fieldKey}`);
                    const radioJson = row.querySelector(`#json_choice_${biId}_${field_key}`);
                    
                    const oldVal = item.conflicts[fieldKey].old_value;
                    const newVal = item.conflicts[fieldKey].new_value;
                    const preselectedVal = item.new_values[fieldKey]; // This comes from backend's proposed

                    // Determine which radio to check based on preselected value
                    if ((preselectedVal === oldVal) || (oldVal === "N/A (Empty)" && preselectedVal === null)) {
                        if (radioDb) radioDb.checked = true;
                        manualInput.value = (oldVal !== "N/A (Empty)") ? oldVal : '';
                    } else if ((preselectedVal === newVal) || (newVal === "N/A (Empty)" && preselectedVal === null)) {
                        if (radioJson) radioJson.checked = true;
                        manualInput.value = (newVal !== "N/A (Empty)") ? newVal : '';
                    } else {
                        // If preselectedVal doesn't match old/new, it's a custom manual input
                        if (radioDb) radioDb.checked = false;
                        if (radioJson) radioJson.checked = false;
                        manualInput.value = (preselectedVal !== null) ? preselectedVal : '';
                    }
                } else if (status === 'new') {
                    // For new items, set manual input to JSON value
                    manualInput.value = (item.json_data[fieldKey] !== null) ? item.json_data[fieldKey] : '';
                } else if (status === 'no_change') {
                    // For no_change items, set manual input to DB value and disable
                    manualInput.value = (item.db_data[fieldKey] !== null) ? item.db_data[fieldKey] : '';
                    manualInput.disabled = true;
                }
            }
        });

        // --- Event Listener for Radio Buttons (DB/JSON choice) ---
        // This updates the corresponding manual input when a radio button is clicked
        previewRows.forEach(row => {
            row.querySelectorAll('.radio-choice').forEach(radio => {
                radio.addEventListener('change', function() {
                    const biId = this.dataset.biId;
                    const fieldKey = this.dataset.field;
                    const manualInput = row.querySelector(`textarea.final-value-input[data-field="${fieldKey}"]`);
                    
                    // Find the original item data for this row
                    const itemIndex = parseInt(row.dataset.rowIndex);
                    const currentItemData = previewData[itemIndex];

                    if (this.value === 'db') {
                        const val = currentItemData.conflicts[fieldKey]?.old_value;
                        manualInput.value = (val !== "N/A (Empty)") ? val : '';
                    } else if (this.value === 'json') {
                        const val = currentItemData.conflicts[fieldKey]?.new_value;
                        manualInput.value = (val !== "N/A (Empty)") ? val : '';
                    }
                });
            });

            // --- Event Listener for Manual Override Textarea ---
            // When a user types in the manual override, deselect the radio buttons
            row.querySelectorAll('textarea.final-value-input').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const fieldKey = this.dataset.field;
                    const biId = row.dataset.biId;
                    // Deselect any radio buttons for this field if user manually types
                    row.querySelectorAll(`input[name="choice_${biId}_${fieldKey}"]`).forEach(radio => {
                        radio.checked = false;
                    });
                });
            });

            // --- Event Listener for Action Radios (Add/Update/Skip) ---
            // Enable/disable inputs based on action choice
            row.querySelectorAll('.action-radio').forEach(actionRadio => {
                actionRadio.addEventListener('change', function() {
                    const action = this.value; // 'add', 'update', 'skip'
                    const inputs = row.querySelectorAll('.final-value-input, .final-area-select, .radio-choice');
                    
                    inputs.forEach(input => {
                        // Original radio buttons are disabled if status is skipped
                        // General rule: if action is 'skip', disable everything editable for that row
                        if (action === 'skip') {
                            input.disabled = true;
                            if (input.type === 'radio') {
                                input.checked = false; // Deselect radio choices
                            }
                        } else {
                            // Re-enable inputs for 'add' or 'update'
                            // For 'name' and 'area_id' and non-conflicting fields, they are always enabled if action is not skip
                            // For conflicting fields, enable manual input and radio choices
                            const itemIndex = parseInt(row.dataset.rowIndex);
                            const currentItemData = previewData[itemIndex];
                            const fieldKey = input.dataset.field; // Check data-field attribute

                            // Enable name and area_id if not skipped
                            if (fieldKey === 'name' || fieldKey === 'area_id') {
                                if (action !== 'skip') {
                                    input.disabled = false;
                                }
                            }
                            // For other fields, enable if conflict or new, and action is not skip
                            else if (fieldKey in stepFieldsConfig) { // Ensure it's a data field
                                if (fieldKey in currentItemData.conflicts || currentItemData.status === 'new') {
                                    input.disabled = false;
                                } else if (currentItemData.status === 'no_change') {
                                    input.disabled = true; // Still disabled if no change
                                }
                            }
                        }
                    });

                    // Ensure specific action radios are disabled as per business logic:
                    // If action is 'add', 'update' radio must be disabled (and vice versa)
                    const biId = row.dataset.biId;
                    const addRadio = row.querySelector(`#action_add_${biId}`);
                    const updateRadio = row.querySelector(`#action_update_${biId}`);

                    if (action === 'add') {
                        if (updateRadio) updateRadio.disabled = true;
                        if (addRadio) addRadio.disabled = false; // Just to be explicit
                    } else if (action === 'update' || action === 'no_change') {
                        if (addRadio) addRadio.disabled = true;
                        if (updateRadio) updateRadio.disabled = false; // Just to be explicit
                    } else if (action === 'skip') {
                        if (addRadio) addRadio.disabled = false; // User can manually choose to add
                        if (updateRadio) updateRadio.disabled = false; // User can manually choose to update
                    }
                });
            });
        });


        // --- Finalize Import Button Logic ---
        confirmBtn.addEventListener('click', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const resolvedData = [];
            let isValid = true; // Flag for client-side validation

            previewRows.forEach(row => {
                const biId = row.dataset.biId;
                const actionRadio = row.querySelector(`input[name="action_${biId}"]:checked`);
                
                if (!actionRadio) {
                    isValid = false;
                    alert(`Action (Add/Update/Skip) not selected for step ${biId}.`);
                    return;
                }

                const action = actionRadio.value;

                let finalData = {};
                // Only collect final data if action is 'add' or 'update'
                if (action === 'add' || action === 'update') {
                    // Collect name and area_id from their specific inputs
                    finalData['name'] = getFieldValue(row, 'name');
                    finalData['area_id'] = getFieldValue(row, 'area_id'); // From select

                    if (!finalData['name']) {
                        isValid = false;
                        alert(`Name is required for step ${biId}.`);
                        return;
                    }
                    if (!finalData['area_id']) {
                        isValid = false;
                        alert(`Area is required for step ${biId}.`);
                        return;
                    }
                    
                    // Collect other fields based on user selection or manual input
                    for (const fieldKey in stepFieldsConfig) {
                        if (fieldKey === 'name') continue; // Already collected
                        
                        const manualInput = row.querySelector(`textarea.final-value-input[data-field="${fieldKey}"]`);
                        if (manualInput) {
                            finalData[fieldKey] = manualInput.value.trim() === '' ? null : manualInput.value.trim();
                        } else {
                            // If textarea not found, it means it's a no_change field for an existing step.
                            // In this case, we need to pull its value from original 'db_data'.
                            // This scenario needs careful handling. The backend should take care of non-provided fields.
                            // For simplicity, we assume all fields are always present in the form and can be null.
                        }
                    }
                }
                
                resolvedData.push({
                    bi_id: biId,
                    action: action,
                    final_data: finalData // This will be empty if action is 'skip'
                });
            });

            if (!isValid) {
                return; // Stop if client-side validation failed
            }

            confirmBtn.disabled = true;
            cancelBtn.disabled = true;

            try {
                const response = await fetch('{{ url_for("injection.finalize_steps_injection") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(resolvedData),
                });

                const result = await response.json();

                if (result.success) {
                    alert('Import finalized successfully! Redirecting...');
                    window.location.href = '{{ url_for("injection.handle_injection") }}';
                } else {
                    alert('Import failed: ' + (result.message || JSON.stringify(result.messages)));
                    console.error('Finalize import failed:', result.messages);
                }
            } catch (error) {
                alert('Network error during import finalization.');
                console.error('Fetch error:', error);
            } finally {
                confirmBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        });

        // --- Cancel Import Button Logic ---
        cancelBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel the import and discard all changes?')) {
                // Redirect back to the main injection page
                window.location.href = '{{ url_for("injection.handle_injection") }}';
            }
        });
    });
</script>
<style>
/* Add some basic styles for the preview page for readability */
.step-injection-preview-page .table td,
.step-injection-preview-page .table th {
    vertical-align: top;
    padding: 8px;
    font-size: 0.85rem;
}

.step-injection-preview-page .badge {
    min-width: 60px;
}

.step-injection-preview-page pre {
    background-color: var(--element-bg-light);
    border: 1px solid var(--raw-light-grey-300);
    border-radius: var(--border-radius-sm);
    padding: 5px;
    margin: 5px 0;
    white-space: pre-wrap; /* Ensure text wraps */
    word-break: break-word; /* Break long words */
    max-height: 80px; /* Limit height of pre blocks */
    overflow-y: auto; /* Add scroll if content overflows */
    font-size: 0.8em;
    line-height: 1.4;
}

.step-injection-preview-page .form-check-label {
    font-weight: normal;
    font-size: 0.8em;
    margin-bottom: 0;
}

.step-injection-preview-page .form-check {
    margin-bottom: 5px; /* Space between radio options */
}

.step-injection-preview-page .final-value-input,
.step-injection-preview-page .final-area-select {
    width: 100%; /* Make textareas/selects take full width */
    font-size: 0.85rem;
    line-height: 1.4;
}

.step-injection-preview-page .preview-cell {
    position: relative; /* For aligning inner elements */
}

.step-injection-preview-page .action-choice .form-check {
    margin-bottom: 5px;
}

.step-injection-preview-page .action-choice .form-check-label {
    font-size: 0.9em;
}
</style>
{% endblock %}
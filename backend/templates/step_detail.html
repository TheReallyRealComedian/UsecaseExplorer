{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block head_extra %}
    {{ super() }}
    <!-- Marked.js for rendering markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}


{% block content %}
<div class="edit-step-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Process Step: {{ step.name }}</h1>
        <div class="actions-button-group">
            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#aiSummaryModal">
                <i class="fas fa-magic"></i> Summarize with AI
            </button>
            <form action="{{ url_for('steps.delete_step', step_id=step.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this process step and all its use cases? This action cannot be undone.');">
                <button type="submit" class="btn btn-sm btn-danger">Delete Step</button>
            </form>
        </div>
    </div>
    <p class="text-color-light mb-3">View and edit all details for this process step. Click "Save Changes" at the bottom when you're done.</p>

    <form method="POST">
        <!-- Markdown/Edit Toggle for LLM Comment 1 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">LLM Comment 1 (AI Summary Target)</h2>
                <button type="button" class="btn btn-sm btn-secondary" id="toggleLlmCommentEditBtn">
                    <i class="fas fa-edit"></i> Edit Content
                </button>
            </div>
            <div class="card-body">
                <div id="llmComment1Display" class="markdown-content">
                    {{ step.llm_comment_1 | markdown | default('<em>No content provided. Use "Summarize with AI" or click "Edit" to add some.</em>' | safe, true) }}
                </div>
                <textarea class="form-control" id="llm_comment_1" name="llm_comment_1" rows="8" style="display: none;">{{ step.llm_comment_1 | default('', true) }}</textarea>
            </div>
        </div>

        <!-- Core Identifiers -->
        <div class="card mb-4">
            <div class="card-header"><h2 class="card-title mb-0">Core Identifiers</h2></div>
            <div class="card-body">
                <dl class="info-list">
                    <dt>Step ID:</dt><dd>{{ step.id }}</dd>
                </dl>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Step Name:</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ step.name }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="bi_id" class="form-label">Business ID (BI_ID):</label>
                        <input type="text" class="form-control" id="bi_id" name="bi_id" value="{{ step.bi_id }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="area_id" class="form-label">Parent Area:</label>
                        <select class="form-select" id="area_id" name="area_id" required>
                            {% for area_opt in all_areas %}
                                <option value="{{ area_opt.id }}" {% if step.area_id == area_opt.id %}selected{% endif %}>
                                    {{ area_opt.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description Fields -->
        <div class="card mb-4">
            <div class="card-header"><h2 class="card-title mb-0">Description</h2></div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="vision_statement" class="form-label">Vision Statement:</label>
                    <textarea class="form-control" id="vision_statement" name="vision_statement" rows="3">{{ step.vision_statement | default('', true) }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="step_description" class="form-label">Short Description:</label>
                    <textarea class="form-control" id="step_description" name="step_description" rows="3">{{ step.step_description | default('', true) }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="summary" class="form-label">Generic Summary:</label>
                    <textarea class="form-control" id="summary" name="summary" rows="5">{{ step.summary | default('', true) }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="what_is_actually_done" class="form-label">What is Actually Done:</label>
                    <textarea class="form-control" id="what_is_actually_done" name="what_is_actually_done" rows="3">{{ step.what_is_actually_done | default('', true) }}</textarea>
                </div>
                 <div class="mb-3">
                    <label for="pain_points" class="form-label">Pain Points:</label>
                    <textarea class="form-control" id="pain_points" name="pain_points" rows="3">{{ step.pain_points | default('', true) }}</textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="in_scope" class="form-label">In Scope:</label>
                        <textarea class="form-control" id="in_scope" name="in_scope" rows="4">{{ step.in_scope | default('', true) }}</textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="out_of_scope" class="form-label">Out of Scope:</label>
                        <textarea class="form-control" id="out_of_scope" name="out_of_scope" rows="4">{{ step.out_of_scope | default('', true) }}</textarea>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="interfaces_text" class="form-label">Interfaces:</label>
                    <textarea class="form-control" id="interfaces_text" name="interfaces_text" rows="3">{{ step.interfaces_text | default('', true) }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="targets_text" class="form-label">Targets:</label>
                    <textarea class="form-control" id="targets_text" name="targets_text" rows="3">{{ step.targets_text | default('', true) }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="raw_content" class="form-label">Raw Content:</label>
                    <textarea class="form-control" id="raw_content" name="raw_content" rows="5">{{ step.raw_content | default('', true) }}</textarea>
                </div>
                <hr>
                <h3>Other LLM Comments</h3>
                {% for i in range(2, 6) %}
                    {% set comment_attr = 'llm_comment_' ~ i %}
                    <div class="mb-3">
                        <label for="llm_comment_{{ i }}" class="form-label">LLM Comment {{ i }}:</label>
                        <textarea class="form-control" id="llm_comment_{{ i }}" name="llm_comment_{{ i }}" rows="2">{{ step[comment_attr] | default('', true) }}</textarea>
                    </div>
                {% endfor %}
                <hr>
                <dl class="info-list">
                    <dt>Created At:</dt><dd>{{ step.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if step.created_at else 'N/A' }}</dd>
                    <dt>Updated At:</dt><dd>{{ step.updated_at.strftime('%Y-%m-%d %H:%M:%S %Z') if step.updated_at else 'N/A' }}</dd>
                </dl>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Back to PTPs</a>
        </div>
    </form>
    
    {# --- NON-FORM SECTIONS --- #}
    <div class="mt-5">
        {% include '_step_detail_use_cases.html' %}
        {% include '_step_detail_relevance.html' %}
    </div>

</div>

<!-- AI Summary Modal -->
<div class="modal fade" id="aiSummaryModal" tabindex="-1" aria-labelledby="aiSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiSummaryModalLabel">AI Summary Generation for LLM Comment 1</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Initial View: Prompt and Model Selection -->
                <div id="aiSummaryInitialView">
                    <div class="mb-3">
                        <label for="aiModelSelect" class="form-label">Select LLM Model:</label>
                        <select id="aiModelSelect" class="form-select">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                         <label for="aiSystemPrompt" class="form-label d-flex justify-content-between">
                            <span>System Prompt:</span>
                            <button class="btn btn-sm btn-link p-0" id="saveSystemPromptBtn">Save Prompt</button>
                        </label>
                        <textarea id="aiSystemPrompt" class="form-control" rows="8"></textarea>
                        <div class="form-text">The prompt must include `{area_description}` and `{process_step_fields}` placeholders.</div>
                        <div id="savePromptStatus" class="form-text small"></div>
                    </div>
                </div>

                <!-- Result View: Left/Right Comparison (Initially hidden) -->
                <div id="aiSummaryResultView" class="d-none">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Current LLM Comment 1</h5>
                            <div id="currentSummaryDisplay" class="p-2 border rounded bg-light" style="min-height: 200px; white-space: pre-wrap;"></div>
                        </div>
                        <div class="col-md-6">
                            <h5>AI Suggested Content (Editable)</h5>
                            <textarea id="aiSuggestedSummary" class="form-control" rows="8" style="min-height: 200px;"></textarea>
                        </div>
                    </div>
                </div>

                <div id="aiSummaryErrorLog" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close / Discard</button>
                <button type="button" class="btn btn-primary" id="generateSummaryBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Summarize
                </button>
                <button type="button" class="btn btn-success d-none" id="acceptSummaryBtn">Accept Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggleLlmCommentEditBtn');
    const displayDiv = document.getElementById('llmComment1Display');
    const editTextarea = document.getElementById('llm_comment_1');

    if (toggleBtn && displayDiv && editTextarea) {
        let isEditing = false;
        toggleBtn.addEventListener('click', function() {
            isEditing = !isEditing;
            if (isEditing) {
                displayDiv.style.display = 'none';
                editTextarea.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye"></i> View Markdown';
                this.classList.replace('btn-secondary', 'btn-info');
            } else {
                const newMarkdown = editTextarea.value;
                displayDiv.innerHTML = newMarkdown.trim() ? marked.parse(newMarkdown) : '<em>No content provided. Use "Summarize with AI" or click "Edit" to add some.</em>';
                displayDiv.style.display = 'block';
                editTextarea.style.display = 'none';
                this.innerHTML = '<i class="fas fa-edit"></i> Edit Content';
                this.classList.replace('btn-info', 'btn-secondary');
            }
        });
    }

    // --- AI Summary Modal Logic ---
    const stepId = {{ step.id }};
    const defaultSystemPrompt = `You are an expert business analyst. Your task is to synthesize information about a process step and create a concise, professional summary for it.

Context about the business area:
{area_description}

Detailed fields for the process step:
{process_step_fields}

Based ONLY on the information provided, generate a single paragraph for the 'LLM Comment 1' field. The summary should be clear, objective, and capture the essence of the process step. Do not add any information not present in the context. Output only the summary text, with no introductory phrases like "Here is the summary:".`;
    
    const savedSystemPrompt = {{ current_user.step_summary_system_prompt|tojson|safe }} || defaultSystemPrompt;

    const modalElement = document.getElementById('aiSummaryModal');
    const aiModelSelect = document.getElementById('aiModelSelect');
    const aiSystemPrompt = document.getElementById('aiSystemPrompt');
    const saveSystemPromptBtn = document.getElementById('saveSystemPromptBtn');
    const savePromptStatus = document.getElementById('savePromptStatus');
    const generateSummaryBtn = document.getElementById('generateSummaryBtn');
    const acceptSummaryBtn = document.getElementById('acceptSummaryBtn');
    const aiErrorLog = document.getElementById('aiSummaryErrorLog');

    const initialView = document.getElementById('aiSummaryInitialView');
    const resultView = document.getElementById('aiSummaryResultView');
    const currentSummaryDisplay = document.getElementById('currentSummaryDisplay');
    const aiSuggestedSummary = document.getElementById('aiSuggestedSummary');
    
    // Correct target textarea
    const mainTargetTextarea = document.getElementById('llm_comment_1'); 
    
    // NO LONGER NEEDED: const mainSaveChangesBtn = document.querySelector('form button[type="submit"]');

    async function populateAiModels() {
        try {
            const response = await fetch('/llm/get_llm_models');
            const data = await response.json();
            if (data.success && data.models) {
                aiModelSelect.innerHTML = '';
                if (data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        aiModelSelect.appendChild(option);
                    });
                } else {
                    aiModelSelect.innerHTML = '<option value="">No models found</option>';
                    generateSummaryBtn.disabled = true;
                }
            }
        } catch (error) { console.error("Error fetching LLM models:", error); }
    }

    modalElement.addEventListener('show.bs.modal', () => {
        populateAiModels();
        aiSystemPrompt.value = savedSystemPrompt;
        initialView.classList.remove('d-none');
        resultView.classList.add('d-none');
        generateSummaryBtn.classList.remove('d-none');
        acceptSummaryBtn.classList.add('d-none');
        aiErrorLog.textContent = '';
        savePromptStatus.textContent = '';
    });

    saveSystemPromptBtn.addEventListener('click', async () => {
        savePromptStatus.textContent = 'Saving...';
        saveSystemPromptBtn.disabled = true;
        try {
            const response = await fetch('/llm/save-step-summary-prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: aiSystemPrompt.value })
            });
            const result = await response.json();
            savePromptStatus.textContent = result.message;
            savePromptStatus.style.color = result.success ? 'green' : 'red';
        } catch (error) {
            savePromptStatus.textContent = 'Network error.';
            savePromptStatus.style.color = 'red';
        } finally {
            saveSystemPromptBtn.disabled = false;
            setTimeout(() => { savePromptStatus.textContent = ''; }, 3000);
        }
    });

    generateSummaryBtn.addEventListener('click', async () => {
        const payload = {
            step_id: stepId,
            model: aiModelSelect.value,
            prompt: aiSystemPrompt.value
        };

        if (!payload.model) {
            aiErrorLog.textContent = 'Please select a model.';
            return;
        }

        const spinner = generateSummaryBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        generateSummaryBtn.disabled = true;
        aiErrorLog.textContent = '';

        try {
            const response = await fetch('/llm/summarize-step', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.success) {
                currentSummaryDisplay.textContent = mainTargetTextarea.value || 'No current content.';
                aiSuggestedSummary.value = result.message;
                initialView.classList.add('d-none');
                resultView.classList.remove('d-none');
                generateSummaryBtn.classList.add('d-none');
                acceptSummaryBtn.classList.remove('d-none');
            } else {
                aiErrorLog.textContent = `Error: ${result.message}`;
            }
        } catch (error) {
            aiErrorLog.textContent = `Network error: ${error.message}`;
        } finally {
            spinner.classList.add('d-none');
            generateSummaryBtn.disabled = false;
        }
    });

    acceptSummaryBtn.addEventListener('click', () => {
        mainTargetTextarea.value = aiSuggestedSummary.value;
        
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        modalInstance.hide();

        // --- REVERTED TO SIMPLER UX ---
        // Scroll to the main form's target field to show the change
        mainTargetTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Flash the background of the textarea to confirm placement
        mainTargetTextarea.style.transition = 'background-color 0.3s ease';
        mainTargetTextarea.style.backgroundColor = '#d1e7dd'; // Light green flash
        
        setTimeout(() => { 
            mainTargetTextarea.style.backgroundColor = ''; 
        }, 2000);
        
        // Manually update the markdown view as well
        if (displayDiv) {
            const newMarkdown = mainTargetTextarea.value;
            displayDiv.innerHTML = newMarkdown.trim() ? marked.parse(newMarkdown) : '<em>No content provided. Click "Edit" to add some.</em>';
        }
    });
});
</script>
{% endblock %}
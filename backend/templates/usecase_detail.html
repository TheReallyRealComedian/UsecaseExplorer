{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block content %}
<div class="usecase-detail-page">
    <h1>Use Case: {{ usecase.name }}</h1>
    <p class="text-color-light mb-3">Detailed information and relevance links for this use case.</p>

    <div class="card mb-3">
        <div class="card-header">
             <h2 class="card-title">Details</h2>
        </div>
        <dl>
            <dt>Use Case ID:</dt>
            <dd>{{ usecase.id }}</dd>

            <dt>Business ID (BI_ID):</dt>
            <dd>{{ usecase.bi_id }}</dd>

            <dt>Area:</dt>
            <dd>{{ usecase.process_step.area.name if usecase.process_step and usecase.process_step.area else 'N/A' }}</dd>

            <dt>Process Step:</dt>
            <dd>{{ usecase.process_step.name if usecase.process_step else 'N/A' }} (BI_ID: {{ usecase.process_step.bi_id if usecase.process_step else 'N/A' }})</dd>

            <dt>Summary:</dt>
            <dd>{{ usecase.summary | default('N/A', true) }}</dd>

            <dt>Inspiration:</dt>
            <dd>{{ usecase.inspiration | default('N/A', true) }}</dd>

            <dt>Raw Content:</dt>
            <dd>
                {% if usecase.raw_content %}
                    <pre>{{ usecase.raw_content }}</pre>
                {% else %}
                    N/A
                {% endif %}
            </dd>

            <dt>LLM Comment 1:</dt> <dd>{{ usecase.llm_comment_1 | default('N/A', true) }}</dd>
            <dt>LLM Comment 2:</dt> <dd>{{ usecase.llm_comment_2 | default('N/A', true) }}</dd>
            <dt>LLM Comment 3:</dt> <dd>{{ usecase.llm_comment_3 | default('N/A', true) }}</dd>
            <dt>LLM Comment 4:</dt> <dd>{{ usecase.llm_comment_4 | default('N/A', true) }}</dd>
            <dt>LLM Comment 5:</dt> <dd>{{ usecase.llm_comment_5 | default('N/A', true) }}</dd>

            <dt>Created At:</dt>
            <dd>{{ usecase.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if usecase.created_at else 'N/A' }}</dd>

            <dt>Updated At:</dt>
            <dd>{{ usecase.updated_at.strftime('%Y-%m-%d %H:%M:%S %Z') if usecase.updated_at else 'N/A' }}</dd>
        </dl>
    </div>


    <div class="relevance-section">
        <h2>Relevance Links</h2>

        <div class="card mb-3">
             <div class="card-header">
                 <h4 class="card-title mb-0">Relevant Areas (From This Use Case)</h4>
             </div>
            {% if usecase.relevant_to_areas %}
                <ul>
                    {% for rel in usecase.relevant_to_areas | sort(attribute='relevance_score', reverse=True) %}
                        <li>
                            <strong>Area:</strong> {{ rel.target_area.name if rel.target_area else 'N/A' }}<br>
                            <strong>Score:</strong> {{ rel.relevance_score }}/100<br>
                            {% if rel.relevance_content %}
                                <strong>Content:</strong> <pre>{{ rel.relevance_content }}</pre>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="p-3 mb-0"><em>No relevance links to Areas found.</em></p>
            {% endif %}
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h4 class="card-title mb-0">Relevant Process Steps (From This Use Case)</h4>
            </div>
            {% if usecase.relevant_to_steps %}
                <ul>
                    {% for rel in usecase.relevant_to_steps | sort(attribute='relevance_score', reverse=True) %}
                         <li>
                            <strong>Step:</strong> {{ rel.target_process_step.name if rel.target_process_step else 'N/A' }}
                            (BI_ID: {{ rel.target_process_step.bi_id if rel.target_process_step else 'N/A' }})<br>
                            <strong>Score:</strong> {{ rel.relevance_score }}/100<br>
                            {% if rel.relevance_content %}
                                <strong>Content:</strong> <pre>{{ rel.relevance_content }}</pre>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                 <p class="p-3 mb-0"><em>No relevance links to Process Steps found.</em></p>
            {% endif %}
        </div>

        <div class="card mb-3">
             <div class="card-header">
                <h4 class="card-title mb-0">Relevant Use Cases (From This Use Case)</h4>
            </div>
            {% if usecase.relevant_to_usecases_as_source %}
                <ul>
                     {% for rel in usecase.relevant_to_usecases_as_source | sort(attribute='relevance_score', reverse=True) %}
                        <li>
                            <strong>To Use Case:</strong>
                            {% if rel.target_usecase %}
                                <a href="{{ url_for('usecases.view_usecase', usecase_id=rel.target_usecase.id) }}">{{ rel.target_usecase.name }}</a>
                                (BI_ID: {{ rel.target_usecase.bi_id }})
                            {% else %}
                                N/A (Error loading target use case)
                            {% endif %}<br>
                            <strong>Score:</strong> {{ rel.relevance_score }}/100<br>
                            {% if rel.relevance_content %}
                                <strong>Content:</strong> <pre>{{ rel.relevance_content }}</pre>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                 <p class="p-3 mb-0"><em>No relevance links to other Use Cases found originating from this one.</em></p>
            {% endif %}
        </div>
        {# --- END OUTGOING RELEVANT USE CASES CARD --- #}

        {# --- START INCOMING LINKS SECTION --- #}
        <div class="card mb-3">
             <div class="card-header">
                <h4 class="card-title mb-0">Relevant Links (From Other Use Cases To This One)</h4>
            </div>
            {% if usecase.relevant_to_usecases_as_target %}
                <ul>
                     {% for rel in usecase.relevant_to_usecases_as_target | sort(attribute='relevance_score', reverse=True) %}
                        <li>
                            <strong>From Use Case:</strong>
                            {% if rel.source_usecase %} {# Check if source UC loaded #}
                                <a href="{{ url_for('usecases.view_usecase', usecase_id=rel.source_usecase.id) }}">{{ rel.source_usecase.name }}</a>
                                (BI_ID: {{ rel.source_usecase.bi_id }})
                            {% else %}
                                N/A (Error loading source use case)
                            {% endif %}<br>
                            <strong>Score:</strong> {{ rel.relevance_score }}/100<br>
                            {% if rel.relevance_content %}
                                <strong>Content:</strong> <pre>{{ rel.relevance_content }}</pre>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                 <p class="p-3 mb-0"><em>No relevance links from other Use Cases found pointing to this one.</em></p>
            {% endif %}
        </div>
        {# --- END INCOMING LINKS SECTION --- #}

    </div> {# End relevance-section div #}


    <div class="add-relevance-forms mt-3">
        <h3>Add New Relevance Link (From This Use Case)</h3>

        {# Form for Area Relevance #}
        <form action="{{ url_for('relevance.add_area_relevance') }}" method="post" class="add-relevance-form mb-3 p-3 border rounded">
            <h4>Link to Area</h4>
            <input type="hidden" name="source_usecase_id" value="{{ usecase.id }}">
            <div class="mb-2">
                <label for="target_area_id" class="form-label">Select Area:</label>
                <select name="target_area_id" id="target_area_id" class="form-select" required>
                    <option value="">-- Select an Area --</option>
                    {% for area in all_areas %}
                         <option value="{{ area.id }}">{{ area.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label for="area_relevance_score" class="form-label">Score (0-100):</label>
                <input type="number" name="relevance_score" id="area_relevance_score" class="form-control" min="0" max="100" required>
            </div>
            <div class="mb-2">
                <label for="area_relevance_content" class="form-label">Content (Optional):</label>
                <textarea name="relevance_content" id="area_relevance_content" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Add Area Link</button>
        </form>

        {# Form for Step Relevance #}
        <form action="{{ url_for('relevance.add_step_relevance') }}" method="post" class="add-relevance-form mb-3 p-3 border rounded">
            <h4>Link to Process Step</h4>
            <input type="hidden" name="source_usecase_id" value="{{ usecase.id }}">
             <div class="mb-2">
                <label for="target_step_id" class="form-label">Select Process Step:</label>
                <select name="target_process_step_id" id="target_step_id" class="form-select" required>
                    <option value="">-- Select a Step --</option>
                    {% for step in all_steps %}
                        <option value="{{ step.id }}">{{ step.name }} ({{ step.bi_id }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label for="step_relevance_score" class="form-label">Score (0-100):</label>
                <input type="number" name="relevance_score" id="step_relevance_score" class="form-control" min="0" max="100" required>
            </div>
            <div class="mb-2">
                <label for="step_relevance_content" class="form-label">Content (Optional):</label>
                <textarea name="relevance_content" id="step_relevance_content" class="form-control" rows="3"></textarea>
            </div>
             <button type="submit" class="btn btn-primary btn-sm">Add Step Link</button>
        </form>

        {# Form for Use Case Relevance #}
        <form action="{{ url_for('relevance.add_usecase_relevance') }}" method="post" class="add-relevance-form mb-3 p-3 border rounded">
             <h4>Link to another Use Case</h4>
            <input type="hidden" name="source_usecase_id" value="{{ usecase.id }}">
             <div class="mb-2">
                <label for="target_usecase_id" class="form-label">Select Use Case:</label>
                <select name="target_usecase_id" id="target_usecase_id" class="form-select" required>
                    <option value="">-- Select a Use Case --</option>
                    {% for other_uc in other_usecases %}
                        <option value="{{ other_uc.id }}">{{ other_uc.name }} ({{ other_uc.bi_id }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label for="uc_relevance_score" class="form-label">Score (0-100):</label>
                <input type="number" name="relevance_score" id="uc_relevance_score" class="form-control" min="0" max="100" required>
            </div>
            <div class="mb-2">
                <label for="uc_relevance_content" class="form-label">Content (Optional):</label>
                <textarea name="relevance_content" id="uc_relevance_content" class="form-control" rows="3"></textarea>
            </div>
             <button type="submit" class="btn btn-primary btn-sm">Add Use Case Link</button>
        </form>
    </div>

    <div class="card mt-3">
        <div class="card-header">
             <h2 class="card-title">LLM Interaction</h2>
        </div>
        <div class="card-body p-3">
            <p><em>(LLM query controls and results for this Use Case will go here in the future)</em></p>
             {# Example Link - Replace with actual functionality later #}
             <a href="{{ url_for('llm.analyze_usecase', usecase_id=usecase.id) }}" class="btn btn-info btn-sm">Analyze with LLM</a>
        </div>
    </div>

    <div class="mt-4">
        
    </div>


</div> {# End usecase-detail-page wrapper #}
{% endblock %}
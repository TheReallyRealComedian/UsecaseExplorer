{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>{{ title }}</h1>
        <p>A comprehensive digital transformation roadmap</p>
    </div>

    {% set area_style_map = {
        "Bio Excellence": "bio-excellence",
        "Logistics": "logistics",
        "Maintenance": "maintenance",
        "Manufacturing": "manufacturing",
        "Performance Management": "performance",
        "Quality Assurance": "quality-assurance",
        "Quality Control": "quality-control",
        "Strategic Partner Management": "strategic-partner",
        "Supply Chain Management": "supply-chain"
    } %}

    {# Macro to sanitize area names for use as valid HTML IDs and CSS classes.
       Note the {{- ... -}} to strip whitespace from the macro's output block itself. #}
    {% macro get_sanitized_id(area_name) %}
        {{- area_name | replace('\n', '') | replace('\r', '') | lower | replace(' ', '-') | replace('&', 'and') | replace('/', '-') | replace('(', '') | replace(')', '') | replace('.', '') | replace(',', '') | replace(':', '') | replace(';', '') | replace("'", "") | replace('"', "") -}}
    {% endmacro %}

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        {% if areas %}
            {% for area in areas | sort(attribute='name') %}
                {% set area_id_str = get_sanitized_id(area.name) %}
                {# Use {{- ... -}} to strip whitespace around the variable inside the attribute value #}
                <button class="tab-button {% if loop.first %}active{% endif %}" onclick="showTab('{{- area_id_str -}}', this)">
                    {{ area.name }} <span class="tab-badge">{{ area.process_steps | length }}</span>
                </button>
            {% endfor %}
        {% else %}
             <p class="text-muted text-center p-3">No areas found.</p>
        {% endif %}
    </div>

    <!-- Tab Content -->
    {% if areas %}
        {% for area in areas | sort(attribute='name') %}
            {% set area_id = get_sanitized_id(area.name) %}
            {# Use {{- ... -}} to strip whitespace around the variable inside the attribute value #}
                <div class="tab-content {% if loop.first %}active{% endif %} {{ area_style_map.get(area.name, 'default-color') }}" id="{{- area_id -}}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Steps in {{ area.name }}</h3>
                        <a href="{{ url_for('areas.view_area', area_id=area.id) }}" class="btn btn-sm btn-info">View Full Area Details</a>
                    </div>                {% if area.process_steps %}
                    <div class="cards-grid">
                        {% for step in area.process_steps | sort(attribute='name') %}
                            <div class="process-card" onclick="toggleCard(this)">
                                <div class="card-header">
                                    {# card-number: Use loop.index for sequential numbering within the tab #}
                                    <div class="card-number">{{ loop.index | string | zfill(2) }}</div>
                                    <div class="step-badge">
                                        {# --- MODIFIED LINE --- #}
                                        <a href="{{ url_for('steps.view_step', step_id=step.id) }}" class="text-decoration-none" style="color: inherit;">
                                            Step ID: {{ step.id }}, BI_ID: {{ step.bi_id }}
                                        </a>
                                        {# --- END MODIFICATION --- #}
                                    </div>
                                    <div class="card-title">{{ step.name }}</div>
                                    <div class="card-subtitle">{{ step.step_description | truncate(80, true) | default('No description.', true) }}</div>
                                    <div class="expand-indicator">â–¼</div>
                                </div>
                                <div class="card-content">
                                    {% if step.use_cases %}
                                        {% for use_case in step.use_cases | sort(attribute='name') %}
                                            <a href="{{ url_for('usecases.view_usecase', usecase_id=use_case.id) }}" class="sub-process">
                                                <div class="sub-process-title">{{ use_case.name }}</div>
                                                <div class="sub-process-id">UC ID: {{ use_case.id }}, BI_ID: {{ use_case.bi_id }}</div>
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-use-cases">No use cases found for this process step.</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <h3>{{ area.name }}</h3>
                        <p>No process steps found for this area.</p>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h3>No Areas Available</h3>
            <p>Please add areas to the database using the Data Update page.</p>
        </div>
    {% endif %}
</div>
{% endblock %}
{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block content %}
<div class="llm-data-prep-page">
    <h1>{{ title }}</h1>
    <p class="mb-3">Select process steps and fields to prepare data for LLM comparison or analysis.</p>

    <form method="POST" class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">Selection Criteria</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="area_ids" class="form-label">Filter by Areas (Optional):<span class="selected-count-display" id="area_ids_selected_count"></span></label>
                    <div class="mb-1">
                        <input type="search" id="area_search" class="form-control form-control-sm" placeholder="Search areas...">
                    </div>
                    <div class="d-flex justify-content-end mb-1 small-buttons">
                        <button type="button" class="btn btn-outline-secondary btn-xs me-1" id="selectAllAreas">Select All</button>
                        <button type="button" class="btn btn-outline-secondary btn-xs" id="clearAllAreas">Clear All</button>
                    </div>
                    <select name="area_ids" id="area_ids" class="form-select" multiple size="5">
                        {% for area in areas %}
                            <option value="{{ area.id }}" {% if area.id in selected_area_ids %}selected{% endif %}>
                                {{ area.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">If no areas are selected, steps from all areas (or only specifically selected steps) will be considered.</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="step_ids" class="form-label">Select Process Steps:<span class="selected-count-display" id="step_ids_selected_count"></span></label>
                    <div class="mb-1">
                        <input type="search" id="step_search" class="form-control form-control-sm" placeholder="Search steps...">
                    </div>
                    <div class="d-flex justify-content-end mb-1 small-buttons">
                        <button type="button" class="btn btn-outline-secondary btn-xs me-1" id="selectAllSteps">Select All</button>
                        <button type="button" class="btn btn-outline-secondary btn-xs" id="clearAllSteps">Clear All</button>
                    </div>
                    <select name="step_ids" id="step_ids" class="form-select" multiple size="8">
                        {% for step in all_steps %}
                            <option value="{{ step.id }}"
                                    data-area-id="{{ step.area.id if step.area else '' }}"
                                    {% if step.id in selected_step_ids %}selected{% endif %}>
                                {{ step.name }} ({{ step.area.name if step.area else 'No Area' }} - BI_ID: {{ step.bi_id }})
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Select specific steps. If none selected here but areas are selected above, all steps from those areas will be included.</small>
                </div>
            </div>

            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label d-block mb-0">Select Fields to Include:</label>
                    <div class="small-buttons">
                        <button type="button" class="btn btn-outline-secondary btn-xs me-1" id="selectAllFields">Select All</button>
                        <button type="button" class="btn btn-outline-secondary btn-xs" id="clearAllFields">Clear All</button>
                    </div>
                </div>

                <fieldset class="fieldset-dashed-border">
                    <legend class="fieldset-legend">Identifiers & Basic Info</legend>
                    {% for field_key, field_name in selectable_fields.items() %}
                        {% if field_key in ['name', 'bi_id'] %} {# Adjust this condition for your grouping #}
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="fields" value="{{ field_key }}" id="field_{{ field_key }}"
                                   {% if field_key in selected_fields_form %}checked{% endif %}>
                            <label class="form-check-label" for="field_{{ field_key }}">{{ field_name }}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </fieldset>

                <fieldset class="fieldset-dashed-border">
                    <legend class="fieldset-legend">Descriptive Content</legend>
                    {% for field_key, field_name in selectable_fields.items() %}
                        {% if field_key in ['step_description', 'raw_content', 'summary', 'vision_statement'] %}  {# Adjust this condition #}
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="fields" value="{{ field_key }}" id="field_{{ field_key }}"
                                   {% if field_key in selected_fields_form %}checked{% endif %}>
                            <label class="form-check-label" for="field_{{ field_key }}">{{ field_name }}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </fieldset>
                
                <fieldset class="fieldset-dashed-border">
                    <legend class="fieldset-legend">Operational Details</legend>
                    {% for field_key, field_name in selectable_fields.items() %}
                        {% if field_key in ['in_scope', 'out_of_scope', 'interfaces_text', 'what_is_actually_done', 'pain_points', 'targets_text'] %}  {# Adjust this condition #}
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="fields" value="{{ field_key }}" id="field_{{ field_key }}"
                                   {% if field_key in selected_fields_form %}checked{% endif %}>
                            <label class="form-check-label" for="field_{{ field_key }}">{{ field_name }}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </fieldset>
            </div>

            <button type="submit" class="btn btn-primary">Preview Data</button>
        </div>
    </form>

    {% if prepared_data is not none %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title mb-0">Prepared Data Preview</h2>
        </div>
        <div class="card-body">
            {% if prepared_data %}
                <p>Found {{ prepared_data|length }} process step(s) matching your criteria with the selected fields:</p>
                {# Make the table container horizontally scrollable #}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th class="col-fixed-short">Step ID</th> {# Class for width control #}
                                {% for field_key in selected_fields_form %}
                                    {% set field_name_display = selectable_fields.get(field_key, field_key|capitalize) %}
                                    {% if field_key == 'name' %}
                                        <th class="col-name">{{ field_name_display }}</th> {# Changed from col-fixed-name #}
                                    {% elif field_key == 'bi_id' %}
                                        <th class="col-bi-id">{{ field_name_display }}</th> {# Changed from col-fixed-bi-id #}
                                    {% else %}
                                        <th class="col-content">{{ field_name_display }}</th> {# Added a class for general content columns #}
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for step_item in prepared_data %}
                            <tr>
                                <td class="col-fixed-short">
                                    <a href="{{ url_for('steps.view_step', step_id=step_item.id) }}" title="View full step details">{{ step_item.id }}</a>
                                </td>
                                {% for field_key in selected_fields_form %}
                                    {% set cell_value = step_item[field_key] %}
                                    {% if field_key in ['name', 'bi_id'] %}
                                        <td class="col-{{ field_key }}">
                                            {# cell-display-content for typically short, non-scrolling text #}
                                            <div class="cell-display-content">
                                                <span title="{{ cell_value }}">{{ cell_value if cell_value is not none else 'N/A' }}</span>
                                            </div>
                                        </td>
                                    {% else %}
                                        <td class="col-content">
                                            {# scrollable-cell-content for potentially long, scrollable text #}
                                            <div class="scrollable-cell-content">
                                                {% if cell_value is none %}
                                                    N/A {# N/A now inside the wrapper div #}
                                                {% elif field_key in ['raw_content', 'step_description', 'summary', 'vision_statement', 'in_scope', 'out_of_scope', 'interfaces_text', 'what_is_actually_done', 'pain_points', 'targets_text'] %}
                                                    {# Use pre for multi-line text fields #}
                                                    <pre>{{ cell_value }}</pre>
                                                {% else %}
                                                    {# For other text fields, just display the content #}
                                                    <span title="{{ cell_value }}">{{ cell_value }}</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <h4 class="mb-0">Formatted for LLM (JSON):</h4>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="toggleJsonPreview">
                            <i class="fas fa-eye me-1"></i>Show JSON
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="copyJsonButton">
                            <i class="fas fa-copy me-1"></i>Copy JSON
                        </button>
                    </div>
                </div>
                <div id="jsonPreviewContainer" style="display: none;"> {# Initially hidden #}
                    <pre id="jsonDataPreview" class="p-3 rounded" style="max-height: 400px; overflow-y: auto;">{{ prepared_data | tojson(indent=2) }}</pre>
                </div>
                {# Token count display moved out of the collapsible container so it's always visible if data exists #}
                <p class="text-end text-muted mt-2 mb-0" id="tokenCountDisplay"><strong>Estimated Token Count: {{ total_tokens }}</strong> (using `cl100k_base` encoding)</p>

            {% else %}
                <p class="text-muted"><em>No data to preview based on current selections. Try adjusting your filters or ensure steps exist.</em></p>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>

{% endblock %} {# This closes the 'content' block. #}

{% block scripts %}
{{ super() }} {# If you have scripts in base.html you want to include #}
<script src="{{ url_for('static', filename='js/llm_ui.js') }}"></script>
{% endblock %} {# This closes the 'scripts' block. #}
{% extends "base.html" %}

{% block title %}{{ title }} - Usecase Explorer{% endblock %}

{% block content %}
<div class="llm-data-prep-page">
    <h1>{{ title }}</h1>
    <p class="mb-3">Select process steps and fields to prepare data for LLM comparison or analysis.</p>

    <form method="POST" class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">Selection Criteria</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="area_ids" class="form-label">Filter by Areas (Optional):</label>
                    <select name="area_ids" id="area_ids" class="form-select" multiple size="5">
                        {% for area in areas %}
                            <option value="{{ area.id }}" {% if area.id in selected_area_ids %}selected{% endif %}>
                                {{ area.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">If no areas are selected, steps from all areas (or only specifically selected steps) will be considered.</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="step_ids" class="form-label">Select Process Steps:</label>
                    <select name="step_ids" id="step_ids" class="form-select" multiple size="8">
                        {% for step in all_steps %}
                            <option value="{{ step.id }}" {% if step.id in selected_step_ids %}selected{% endif %}>
                                {{ step.name }} ({{ step.area.name if step.area else 'No Area' }} - BI_ID: {{ step.bi_id }})
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Select specific steps. If none selected here but areas are selected above, all steps from those areas will be included.</small>
                </div>
            </div>

            <div class="mb-4"> {# Increased margin for better separation #}
                <label class="form-label d-block">Select Fields to Include:</label>
                {% for field_key, field_name in selectable_fields.items() %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="fields" value="{{ field_key }}" id="field_{{ field_key }}"
                           {% if field_key in selected_fields_form %}checked{% endif %}>
                    <label class="form-check-label" for="field_{{ field_key }}">{{ field_name }}</label>
                </div>
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary">Preview Data</button>
        </div>
    </form>

    {% if prepared_data is not none %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title mb-0">Prepared Data Preview</h2>
        </div>
        <div class="card-body">
            {% if prepared_data %}
                <p>Found {{ prepared_data|length }} process step(s) matching your criteria with the selected fields:</p>
                <div class="table-responsive"> {# For potentially wide tables #}
                    <table class="table table-striped table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Step ID</th>
                                {% for field_key in selected_fields_form %}
                                    <th>{{ selectable_fields.get(field_key, field_key|capitalize) }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for step_item in prepared_data %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('steps.view_step', step_id=step_item.id) }}" title="View full step details">{{ step_item.id }}</a>
                                </td>
                                {% for field_key in selected_fields_form %}
                                    <td>
                                        {% if step_item[field_key] is string and '\n' in step_item[field_key] %}
                                            <pre style="white-space: pre-wrap; word-break: break-word; margin-bottom: 0; background-color: transparent; border: none; padding: 0; font-size: inherit;">{{ step_item[field_key] | default('N/A', true) }}</pre>
                                        {% else %}
                                            {{ step_item[field_key] | default('N/A', true) }}
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {# You could add a button here to "Copy to Clipboard" or "Send to LLM" in the future #}
                {# Example: Outputting as JSON for easier copy/paste for LLM #}
                <h4 class="mt-4">Formatted for LLM (JSON):</h4>
                <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">{{ prepared_data | tojson(indent=2) }}</pre>

            {% else %}
                <p class="text-muted"><em>No data to preview based on current selections. Try adjusting your filters or ensure steps exist.</em></p>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>

{# Optional: JavaScript for dynamic filtering of steps based on area selection #}
{# This is a bit more involved, but would improve UX. For now, it's server-side filtered on submit. #}
{#
<script>
document.addEventListener('DOMContentLoaded', function () {
    const areaSelect = document.getElementById('area_ids');
    const stepSelect = document.getElementById('step_ids');
    const allStepOptions = Array.from(stepSelect.options).map(opt => ({
        value: opt.value,
        text: opt.text,
        areaId: opt.dataset.areaId // You'd need to add data-area-id="{{ step.area_id }}" to step options in the loop
    }));

    if (areaSelect && stepSelect) {
        areaSelect.addEventListener('change', function () {
            const selectedAreaIds = Array.from(areaSelect.selectedOptions).map(opt => opt.value);
            const currentSelectedStepValues = Array.from(stepSelect.selectedOptions).map(opt => opt.value);

            stepSelect.innerHTML = ''; // Clear current options

            allStepOptions.forEach(stepOpt => {
                if (selectedAreaIds.length === 0 || selectedAreaIds.includes(stepOpt.areaId)) {
                    const option = new Option(stepOpt.text, stepOpt.value);
                    if (currentSelectedStepValues.includes(stepOpt.value)) {
                        option.selected = true;
                    }
                    stepSelect.add(option);
                }
            });
        });
        // Trigger change on load if areas are pre-selected (e.g., after form submission)
        if (Array.from(areaSelect.selectedOptions).length > 0) {
            areaSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>
#}
{% endblock %}